<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Seat List</title>

</head>
<body>
<h1>Seat List</h1>
<h3 id="userid"></h3>
<p id="using-seat"></p>

<table border="1">
    <thead>
    <tr>
        <th>Seat ID</th>
        <th>Is Using</th>
        <th>Desk ID</th>
        <th>선택</th>
    </tr>
    </thead>
    <tbody id="seatTableBody">
    <!-- Data will be dynamically added here -->
    </tbody>
</table>

<script>
    async function request() {
        let myId = null
        let mySeat = null
        const getIdResponse = await fetch('../api/member/my-id',
            {
                method: 'GET',
            });
        const idData = await getIdResponse.json();

        if (getIdResponse.status === 200) {
            myId = idData.data.user_id
            document.getElementById("userid").innerText = `안녕하세요, ${myId}님.`
            const getSeatResponse = await fetch('../api/member/my-seat',
                {
                    method: 'GET',
                });
            const seatData = await getSeatResponse.json();

            if (getSeatResponse.status === 200) {
                mySeat = seatData.data.seat_id
                console.log(mySeat)
                console.log(typeof mySeat)
            }
        }
        if (mySeat != null)
            document.getElementById("using-seat").innerText = `현재 ${mySeat}번 좌석을 사용 중 입니다. `


        const response = await fetch('../api/library/seat-list',
            {
                method: 'GET',
            });
        const data = await response.json();
        console.log(data)

        const tableBody = document.getElementById("seatTableBody");

        data.data.forEach(seat => {
            const row = document.createElement("tr");

            const seatIdCell = document.createElement("td");
            seatIdCell.textContent = seat.seat_id;
            row.appendChild(seatIdCell);

            const isUsingCell = document.createElement("td");
            isUsingCell.textContent = seat.is_using ? "Yes" : "No";
            row.appendChild(isUsingCell);

            const deskIdCell = document.createElement("td");
            deskIdCell.textContent = seat.desk_id;
            row.appendChild(deskIdCell);

            const startUsing = document.createElement("button");
            startUsing.textContent = "사용 시작"
            startUsing.disabled = mySeat !== null ? true : seat.is_using

            startUsing.onclick = (() => {
                const isConfirmed = confirm(`${seat.seat_id}번 좌석을 사용하시겠습니까?`);

                // Check the user's choice
                if (isConfirmed) {
                    const formData = {
                        seat_id: seat.seat_id
                    };


                    (async () => {
                        const response = await fetch('../api/library/login',
                            {
                                method: 'POST',
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(formData)
                            });
                        const data = await response.json();
                        console.log(data)
                        switch (response.status) {
                            case 200:
                                alert(`${seat.seat_id}번 좌석 사용 시작됨!`);
                                break;
                            case 401:
                                alert("사용자 로그인 정보가 유효하지 않습니다.");
                                window.location.href = "../member/login"
                                break;
                            case 403:
                                alert("이미 다른 좌석을 사용하고 있습니다. ");
                                break;
                            case 404:
                                alert("유효하지 않은 좌석 번호입니다. ");
                                break;
                            case 409:
                                alert("이미 사용되고 있는 좌석입니다. ");
                                break;
                            default:
                                alert("예상하지 못한 에러 발생.")
                                break;
                        }

                        location.reload()
                    })();
                } else {
                    // User clicked "Cancel" in the confirmation dialog
                    // alert("Operation canceled");
                }
            });
            row.appendChild(startUsing)

            const endUsing = document.createElement("button");
            endUsing.textContent = "사용 종료"
            endUsing.disabled = mySeat !== seat.seat_id
            endUsing.onclick = (() => {
                const isConfirmed = confirm(`${seat.seat_id}번 좌석 사용을 끝내시겠습니까?`);

                // Check the user's choice
                if (isConfirmed) {

                    (async () => {
                        const response = await fetch('../api/library/logout',
                            {
                                method: 'POST',
                                headers: {
                                    "Content-Type": "application/json",
                                }
                            });
                        const data = await response.json();
                        console.log(data)
                        switch (response.status) {
                            case 200:
                                alert(`사용 종료됨!`);
                                break;
                            default:
                                alert("예상하지 못한 에러 발생.")
                                break;
                        }

                        location.reload()
                    })();
                } else {
                    // User clicked "Cancel" in the confirmation dialog
                    // alert("Operation canceled");
                }
            });
            row.appendChild(endUsing)

            tableBody.appendChild(row);
        });
    }

    request();

    function getUserId() {
        const textField = document.getElementById("userid");
        (async () => {
            const response = await fetch('../api/library/login',
                {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(formData)
                });
            const data = await response.json();
            console.log(data)
        })()
    }
</script>
</body>
</html>
